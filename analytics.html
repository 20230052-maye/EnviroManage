<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EnviroManage - Analytics & Reports</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.1.0/dist/chartjs-chart-matrix.min.js"></script>
  <link rel="stylesheet" href="analytics.css" />
</head>
<body>
  <style>
    .chart-card { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 0 8px rgba(0,0,0,0.1); }
    .download-section button { margin: 5px; }
    .info-btn { font-style: italic; cursor: pointer; margin-left: 5px; color:#555; }
  </style>

  <!-- Top Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top" style="height:70px;">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="#">
        <img src="logo.png" alt="BasuraTrack Logo" style="height:40px; width:auto;">
      </a>

      <ul class="navbar-nav ms-auto align-items-center">
        <li class="nav-item me-3">
          <a class="nav-link" href="notification.html"><i class="bi bi-bell-fill"></i></a>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="profileDropdown" data-bs-toggle="dropdown">
            <i class="bi bi-person-circle"></i> Admin
          </a>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><hr class="dropdown-divider"></li>
            <li>
              <a class="dropdown-item text-center" href="#" id="logoutBtn">
                Logout <i class="bi bi-box-arrow-right me-1"></i>
              </a>
            </li>
          </ul>
        </li>
      </ul>
    </div>
  </nav>

  <!-- Sidebar -->
  <div class="sidebar">
    <nav class="nav flex-column">
      <a class="nav-link" href="dashboard.html"><i class="bi bi-house-door-fill me-2"></i> Dashboard</a>
      <a class="nav-link" href="schedule.html"><i class="bi bi-map-fill me-2"></i> Routes & Schedules</a>
      <a class="nav-link" href="trucks.html"><i class="bi bi-truck-front-fill me-2"></i> Trucks & Collectors</a>
      <a class="nav-link" href="collection.html"><i class="bi bi-trash-fill me-2"></i> Collection Records</a>
      <a class="nav-link" href="special.html"><i class="bi bi-exclamation-circle-fill me-2"></i> Special Pickup</a>
      <a class="nav-link" href="resident.html"><i class="bi bi-file-earmark-text-fill me-2"></i> Resident Reports</a>
      <a class="nav-link active" href="analytics.html"><i class="bi bi-bar-chart-fill me-2"></i> Analytics & Reports</a>
      <a class="nav-link" href="announcements.html"><i class="bi bi-megaphone-fill me-2"></i> Announcements</a>
      <a class="nav-link" href="news.html"><i class="bi bi-newspaper me-2"></i> News & Articles</a>
      <a class="nav-link" href="user.html"><i class="bi bi-people-fill me-2"></i> User Management</a>
      <a class="nav-link" href="settings.html"><i class="bi bi-gear-fill me-2"></i> Settings</a>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="container-fluid">

      <div class="card p-4 mb-4">
        <h4 class="fw-semibold text-dark mb-3"><i class="bi bi-bar-chart-fill me-2 text-success"></i>Analytics & Reports</h4>

        <div class="row g-4">

      
           <!-- Bar Chart -->
          <div class="col-lg-6">
            <div class="chart-card">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="fw-semibold mb-2 text-secondary">Waste Collected per Barangay
                  <i class="bi bi-info-circle text-secondary ms-2" data-bs-toggle="tooltip" title="Shows the total waste collected per barangay for selected date."></i>
                </h6>
                <div class="d-flex gap-2">
                  <input type="date" id="barChartDate" class="form-control form-control-sm" style="width:160px;">
                  <button class="btn btn-sm btn-outline-success" id="viewAllBarangaysBtn"></i> View All</button>
                </div>
              </div>
              <canvas id="barChart"></canvas>
            </div>
          </div>

          <!-- Line Chart -->
          <div class="col-lg-6">
            <div class="chart-card">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="fw-semibold mb-2 text-secondary">Weekly Collection Trends
                  <i class="bi bi-info-circle text-secondary ms-2" data-bs-toggle="tooltip" title="Trends of collected waste over a 6-day week (Mon-Sat)."></i>
                </h6>
                <div class="input-group input-group-sm" style="width:200px;">
                  <button class="btn btn-outline-secondary" id="prevWeek">&lt;</button>
                  <input type="text" id="weekRange" class="form-control text-center" readonly>
                  <button class="btn btn-outline-secondary" id="nextWeek">&gt;</button>
                </div>
              </div>
              <canvas id="lineChart"></canvas>
            </div>
          </div>

          <!-- Donut Chart -->
          <div class="col-lg-6">
            <div class="chart-card" style="height:320px;">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="fw-semibold mb-2 text-secondary">Report Resolution Rate (%)
                  <i class="bi bi-info-circle text-secondary ms-2" data-bs-toggle="tooltip" title="Percentage of reported issues resolved within selected month."></i>
                </h6>
                <select id="resolutionMonth" class="form-select form-select-sm" style="width:120px;">
                  <option value="Jan">January</option>
                  <option value="Feb">February</option>
                  <option value="Mar">March</option>
                    <option value="Mar">April</option>
                    <option value="Mar">May</option>
                    <option value="Mar">June</option>
                    <option value="Mar">July</option>
                    <option value="Mar">August</option>
                    <option value="Mar">September</option>
                    <option value="Mar">October</option>
                    <option value="Mar">November</option>
                    <option value="Mar">December</option>
                  
                </select>
              </div>
              <canvas id="pieChart" style="display:block;margin:0 auto;height:230px;"></canvas>
            </div>
          </div>

          <!-- Route Chart -->
          <div class="col-lg-6">
            <div class="chart-card">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="fw-semibold mb-2 text-secondary">Route Efficiency / Duration
                  <i class="bi bi-info-circle text-secondary ms-2" data-bs-toggle="tooltip" title="Planned vs actual duration per route."></i>
                </h6>
                <input type="date" id="routeDate" class="form-control form-control-sm" style="width:160px;">
              </div>
              <canvas id="routeChart"></canvas>
            </div>
          </div>

          <!-- Download Section -->
          <div class="card p-4 download-section text-center">
            <h5 class="fw-semibold mb-3"><i class="bi bi-download me-2"></i>Download Reports</h5>
            <div class="download-buttons justify-content-center">
              <button class="btn btn-success" onclick="downloadPDF()"><i class="bi bi-file-earmark-pdf"></i> PDF</button>
              <button class="btn btn-primary" onclick="downloadCSV()"><i class="bi bi-filetype-csv"></i> CSV</button>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

  <!-- View All Modal -->
  <div class="modal fade" id="viewAllModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
  <h5 class="modal-title" id="viewAllModalLabel">
    <i class="bi bi-bar-chart-fill me-2"></i>Waste Collected per Barangay
  </h5>
  <div class="d-flex align-items-center ms-auto gap-2">
    <input type="date" id="modalBarChartDate" class="form-control form-control-sm" style="width:160px;">
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
  </div>
</div>

        <div class="modal-body">
          <canvas id="barChartModal" style="height:600px;"></canvas>
        </div>
        <div class="modal-footer">
          <button class="btn btn-success" id="downloadModalPDF"><i class="bi bi-file-earmark-pdf me-1"></i> Download</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <script>
  // --------- TOOLTIP ----------
  const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
  [...tooltipTriggerList].map(el => new bootstrap.Tooltip(el));

  // --------- LOGOUT ----------
  document.getElementById('logoutBtn').addEventListener('click', e => {
    e.preventDefault();
    if (confirm("Are you sure you want to log out?")) location.href = "index.html";
  });

  // ========== DATA ==========
  const barDataByDate = {
    "2026-02-01":[1200,950,1340,1100,900],
    "2026-02-02":[1000,880,1200,980,760],
    "2026-02-03":[1400,1100,1500,1250,1020]
  };
  const weeklyLineData = [[200,250,230,280,260,300,320],[180,220,210,260,240,280,300],[260,300,290,330,310,360,380]];
  const resolutionData = { Jan:[75,25], Feb:[82,18], Mar:[90,10] };
  const routeDataByDate = { "2026-02-01":[7.8,8.5,9,7.5,8], "2026-02-02":[8,8.2,8.6,7.9,8.1], "2026-02-03":[9,9.1,9.4,8.8,9] };
  const allBarangays = ["Antipolo","Balubal","Bignay 1","Bignay 2","Bucal","Canda","CastaÃ±as","Concepcion I","Concepcion Banahaw","Concepcion Palasan","Concepcion Pinagbakuran","Gibanga","Guisguis-San Roque","Guisguis-Talon","Janagdong 1","Janagdong 2","Limbon","Lutucan 1","Lutucan Bata","Lutucan Malabag","Mamala I","Mamala II","Manggalang 1","Manggalang Tulo-tulo","Manggalang-Bantilan","Manggalang-Kiling","Montecillo","Morong","Pili","Poblacion 1","Poblacion 2","Poblacion 3","Poblacion 4","Poblacion 5","Poblacion 6","Sampaloc 1","Sampaloc 2","Sampaloc Bogon","Santo Cristo","Talaan Aplaya","Talaan Pantoc","Tumbaga 1","Tumbaga 2"];
  const allBarDataByDate = { "2026-02-01": allBarangays.map(()=>[Math.floor(Math.random()*500)+500,Math.floor(Math.random()*500)+500,Math.floor(Math.random()*500)+500]), "2026-02-02": allBarangays.map(()=>[Math.floor(Math.random()*500)+500,Math.floor(Math.random()*500)+500,Math.floor(Math.random()*500)+500]), "2026-02-03": allBarangays.map(()=>[Math.floor(Math.random()*500)+500,Math.floor(Math.random()*500)+500,Math.floor(Math.random()*500)+500])};

  // ========== BAR CHART ==========
  const barChart = new Chart(document.getElementById("barChart"), {
    type:"bar",
    data:{ labels: allBarangays.slice(0,5), datasets:[{ label:"Waste Collected (kg)", data:barDataByDate["2026-02-01"], backgroundColor:"#66bb6a" }]},
    options:{ responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true,title:{display:true,text:"Kilograms"}}, x:{title:{display:true,text:"Barangay"}}}}
  });
  document.getElementById("barChartDate").value="2026-02-01";

  // ---------- VIEW ALL MODAL ----------
const modalEl = document.getElementById('viewAllModal');
const modal = new bootstrap.Modal(modalEl);
const modalCanvas = document.getElementById("barChartModal");
const modalDatePicker = document.getElementById("modalBarChartDate");

const barChartModal = new Chart(modalCanvas, {
  type: 'bar',
  data: {
    labels: allBarangays,
    datasets: [{
      label: "Waste Collected (kg)",
      data: allBarDataByDate["2026-02-01"].map(arr => arr.reduce((a,b)=>a+b,0)),
      backgroundColor: "#66bb6a"
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { display: false },
      tooltip: {
        callbacks: {
          label: ctx => {
            const idx = ctx.dataIndex;
            const date = modalDatePicker.value;
            const arr = allBarDataByDate[date][idx];
            return `Collections: ${arr.join(", ")} kg (Total: ${arr.reduce((a,b)=>a+b,0)} kg)`;
          }
        }
      }
    },
    scales: {
      y: { beginAtZero:true, title:{ display:true, text:"Kilograms" } },
      x: { ticks:{ autoSkip:false, maxRotation:90, minRotation:45 } }
    },
 plugins: [
  {
    id: 'allBarangayLabel',
    afterDraw(chart) {
      const { ctx, scales } = chart;
      const xScale = scales.x;
      const yPos = xScale.bottom + 20; // 20px below x-axis

      ctx.save();
      ctx.font = 'bold 16px Arial';
      ctx.fillStyle = '#555';
      ctx.textAlign = 'center';
      ctx.fillText('All Barangay', (xScale.left + xScale.right) / 2, yPos);
      ctx.restore();
    }
  }
]


  }
});

// Function to update modal chart by date
function updateModalChart(date) {
  const data = allBarDataByDate[date] || allBarDataByDate["2026-02-01"];
  barChartModal.data.datasets[0].data = data.map(arr => arr.reduce((a,b)=>a+b,0));
  barChartModal.update();
}

document.getElementById("viewAllBarangaysBtn").addEventListener("click", () => {
  modalDatePicker.value = document.getElementById("barChartDate").value;

 modalCanvas.style.height = `${allBarangays.length * 30 + 50}px`; // extra 50px for label
barChartModal.resize();
barChartModal.update();

  updateModalChart(modalDatePicker.value);
  
  

  modal.show();
});


// Update modal when modal date changes
modalDatePicker.addEventListener("change", e => {
  updateModalChart(e.target.value);
});
// Modal PDF download as simple numeric table
document.getElementById("downloadModalPDF").addEventListener("click", () => {
  const doc = new jsPDF('p', 'mm', 'a4');
  const date = modalDatePicker.value;

  // Title
  doc.setFontSize(16);
  doc.text(`Waste Collected per Barangay - ${date}`, 105, 10, { align: 'center' });

  // Table data: sum of all collections per barangay
  const labels = allBarangays;
  const data = allBarDataByDate[date] || allBarDataByDate["2026-02-01"];
  const tableBody = labels.map((label, i) => {
    const total = data[i].reduce((a, b) => a + b, 0);
    return [label, total];
  });

  // Column headers
  const header = ["Barangay", "Waste (kg)"];

  doc.autoTable({
    startY: 20,
    head: [header],
    body: tableBody,
    theme: 'grid',
    headStyles: { fillColor: [102, 187, 106] },
    styles: { fontSize: 10 }
  });

  doc.save(`Waste_Barangay_${date}.pdf`);
});



  // ========= LINE CHART ==========
  let weekIndex=0;
  const lineChart = new Chart(document.getElementById("lineChart"), {
    type:"line",
    data:{ labels:["Mon","Tue","Wed","Thu","Fri","Sat"], datasets:[{label:"Collected Waste (kg)", data:weeklyLineData[weekIndex].slice(0,6), borderColor:"#2e7d32", backgroundColor:"rgba(46,125,50,0.1)", fill:true, tension:0.3 }]},
    options:{ responsive:true, plugins:{legend:{position:"top"}}, scales:{y:{beginAtZero:true}, x:{title:{display:true,text:"Day of Week"}}}}
  });

  function updateWeekRange(){
    const startDate=new Date(); startDate.setDate(startDate.getDate()-startDate.getDay()+weekIndex*7+1);
    const endDate=new Date(startDate); endDate.setDate(startDate.getDate()+5);
    const startStr=startDate.toLocaleDateString('en-US',{month:'short',day:'numeric'});
    const endStr=endDate.toLocaleDateString('en-US',{month:'short',day:'numeric'});
    const year=endDate.getFullYear();
    document.getElementById('weekRange').value=`${startStr} - ${endStr}, ${year}`;
    lineChart.data.datasets[0].data=weeklyLineData[weekIndex].slice(0,6); lineChart.update();
  }
  document.getElementById('prevWeek').addEventListener('click',()=>{weekIndex=(weekIndex+2)%3; updateWeekRange();});
  document.getElementById('nextWeek').addEventListener('click',()=>{weekIndex=(weekIndex+1)%3; updateWeekRange();});
  updateWeekRange();

  // ========= DONUT CHART ==========
  const pieChart = new Chart(document.getElementById("pieChart"), {
    type:'doughnut', data:{labels:["Resolved","Pending"], datasets:[{data:resolutionData.Jan, backgroundColor:["#43a047","#c62828"]}]},
    options:{ responsive:true, plugins:{legend:{position:"bottom"}, tooltip:{callbacks:{label:ctx=>ctx.parsed+"%"}}}},
    plugins:[{ id:'centerText', beforeDraw(chart){ const ctx=chart.ctx; const total=chart.data.datasets[0].data.reduce((a,b)=>a+b,0); const resolved=chart.data.datasets[0].data[0]; const percent=Math.round((resolved/total)*100); ctx.save(); ctx.font='bold 18px Arial'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillStyle='#43a047'; ctx.fillText(percent+'%', chart.width/2, chart.height/2); ctx.restore();}}]
  });
  document.getElementById('resolutionMonth').addEventListener('change', e=>{pieChart.data.datasets[0].data=resolutionData[e.target.value]||resolutionData.Jan; pieChart.update();});

  // ========= ROUTE CHART ==========
  const routeChart = new Chart(document.getElementById("routeChart"),{
    type:'bar',
    data:{ labels:["Route A","Route B","Route C","Route D","Route E"], datasets:[{label:"Planned Shift (hrs)", data:[8,8,8,8,8], backgroundColor:"#a5d6a7"},{label:"Actual Duration (hrs)", data:routeDataByDate["2026-02-01"], backgroundColor:"#66bb6a"}]},
    options:{ responsive:true, plugins:{legend:{position:"top"}}, scales:{y:{beginAtZero:true, title:{display:true,text:"Hours"}}}}
  });
  document.getElementById('routeDate').value="2026-02-01";
  document.getElementById('routeDate').addEventListener('change', e=>{ routeChart.data.datasets[1].data=routeDataByDate[e.target.value]||routeDataByDate["2026-02-01"]; routeChart.update(); });


    const { jsPDF } = window.jspdf;

/* ================= CSV ================= */
function downloadCSV() {
  let csv = "";
  const barDate = document.getElementById("barChartDate").value;

  // Use modal chart data to get all barangays
  const allLabels = allBarangays;
  const allData = allBarDataByDate[barDate] ? allBarDataByDate[barDate].map(arr => arr.reduce((a,b)=>a+b,0)) : barChart.data.datasets[0].data;

  csv += `Waste Collected per Barangay, Date: ${barDate}\nBarangay, Waste (kg)\n`;
  allLabels.forEach((label, i) => {
    csv += `${label}, ${allData[i]}\n`;
  });
  csv += "\n";

  // Line chart
  csv += `Weekly Collection Trends, ${document.getElementById('weekRange').value}\nDay, Waste (kg)\n`;
  lineChart.data.labels.forEach((day,i)=>csv += `${day}, ${lineChart.data.datasets[0].data[i]}\n`);
  csv += "\n";

  // Donut chart
  const month = document.getElementById('resolutionMonth').value;
  csv += `Report Resolution Rate (%), Month: ${month}\nStatus, Percentage\n`;
  ["Resolved","Pending"].forEach((label,i)=>{ csv += `${label}, ${pieChart.data.datasets[0].data[i]}\n`; });
  csv += "\n";

  // Route chart
  const routeDate = document.getElementById('routeDate').value;
  csv += `Route Efficiency, Date: ${routeDate}\nRoute, Planned (hrs), Actual (hrs)\n`;
  routeChart.data.labels.forEach((label,i)=>csv += `${label}, ${routeChart.data.datasets[0].data[i]}, ${routeChart.data.datasets[1].data[i]}\n`);

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "EnviroManage_Report.csv";
  link.click();
}

/* ================= PDF ================= */
function downloadPDF() {
  const doc = new jsPDF();
  let y = 10;
  doc.setFontSize(16); 
  doc.text("EnviroManage Analytics Report", 105, y, {align: "center"}); 
  y+=10;

  const barDate = document.getElementById("barChartDate").value;

  // Use all barangays for PDF
  const allLabels = allBarangays;
  const allData = allBarDataByDate[barDate] ? allBarDataByDate[barDate].map(arr => arr.reduce((a,b)=>a+b,0)) : barChart.data.datasets[0].data;

  doc.setFontSize(12); 
  doc.text(`Waste Collected per Barangay (Date: ${barDate})`, 10, y); 
  y+=6;
  doc.autoTable({ 
    startY: y, 
    head: [["Barangay", "Waste (kg)"]], 
    body: allLabels.map((label,i)=>[label, allData[i]]), 
    theme: 'grid', 
    headStyles:{ fillColor:[102,187,106] }, 
    styles:{ fontSize:10 } 
  });
  y = doc.lastAutoTable.finalY + 10;

  // Line chart
  doc.text(`Weekly Collection Trends (${document.getElementById('weekRange').value})`, 10, y); y+=6;
  doc.autoTable({ startY:y, head:[["Day","Waste (kg)"]], body:lineChart.data.labels.map((day,i)=>[day, lineChart.data.datasets[0].data[i]]), theme:'grid', headStyles:{fillColor:[46,125,50]}, styles:{fontSize:10}}); y=doc.lastAutoTable.finalY+10;

  // Donut chart
  const month = document.getElementById('resolutionMonth').value;
  doc.text(`Report Resolution Rate (Month: ${month})`, 10, y); y+=6;
  doc.autoTable({ startY:y, head:[["Status","Percentage"]], body:[["Resolved",pieChart.data.datasets[0].data[0]],["Pending",pieChart.data.datasets[0].data[1]]], theme:'grid', headStyles:{ fillColor:[67,160,71] }, styles:{ fontSize:10 }}); 
  y = doc.lastAutoTable.finalY + 10;

  // Route chart
  const routeDate = document.getElementById('routeDate').value;
  doc.text(`Route Efficiency (Date: ${routeDate})`, 10, y); y+=6;
  doc.autoTable({ startY:y, head:[["Route","Planned (hrs)","Actual (hrs)"]], body: routeChart.data.labels.map((label,i)=>[label, routeChart.data.datasets[0].data[i], routeChart.data.datasets[1].data[i]]), theme:'grid', headStyles:{ fillColor:[102,187,106] }, styles:{ fontSize:10 }});

  doc.save("EnviroManage_Report.pdf");
}

  </script>
</body>

</html>
