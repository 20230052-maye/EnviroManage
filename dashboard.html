<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EnviroManage Admin Dashboard</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- MapLibre -->
  <link href="https://unpkg.com/maplibre-gl@4.1.0/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@4.1.0/dist/maplibre-gl.js"></script>

  <link rel="stylesheet" href="style.css">
</head>

<body>
<!-- Top Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark fixed-top" style="height:70px;">
  <div class="container-fluid">
    <a class="navbar-brand d-flex align-items-center" href="#">
      <img src="logo.png" alt="BasuraTrack Logo" style="height:40px;">
    </a>
    <ul class="navbar-nav ms-auto align-items-center">
      <li class="nav-item me-3">
        <a class="nav-link" href="notification.html"><i class="bi bi-bell-fill"></i></a>
      </li>
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
          <i class="bi bi-person-circle"></i> Admin
        </a>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><hr class="dropdown-divider"></li>
          <li>
            <a class="dropdown-item text-center" href="index.html" id="logoutBtn">
              Logout <i class="bi bi-box-arrow-right me-1"></i>
            </a>
          </li>
        </ul>
      </li>
    </ul>
  </div>
</nav>

<!-- Sidebar -->
<div class="sidebar">
  <nav class="nav flex-column">
    <a class="nav-link active" href="dashboard.html"><i class="bi bi-house-door-fill me-2"></i> Dashboard</a>
    <a class="nav-link" href="schedule.html"><i class="bi bi-map-fill me-2"></i> Routes & Schedules</a>
    <a class="nav-link" href="trucks.html"><i class="bi bi-truck-front-fill me-2"></i> Trucks & Collectors</a>
    <a class="nav-link" href="collection.html"><i class="bi bi-trash-fill me-2"></i> Collection Records</a>
    <a class="nav-link" href="special.html"><i class="bi bi-exclamation-circle-fill me-2"></i> Special Pickup</a>
    <a class="nav-link" href="resident.html"><i class="bi bi-file-earmark-text-fill me-2"></i> Resident Reports</a>
    <a class="nav-link" href="analytics.html"><i class="bi bi-bar-chart-fill me-2"></i> Analytics & Reports</a>
    <a class="nav-link" href="announcements.html"><i class="bi bi-megaphone-fill me-2"></i> Announcements</a>
    <a class="nav-link" href="news.html"><i class="bi bi-newspaper me-2"></i> News & Articles</a>
    <a class="nav-link" href="user.html"><i class="bi bi-people-fill me-2"></i> User Management</a>
    <a class="nav-link" href="settings.html"><i class="bi bi-gear-fill me-2"></i> Settings</a>
  </nav>
</div>

<!-- Main -->
<div class="main-content p-4">
  <div class="card p-4 shadow-sm mt-2">
    <h4 class="fw-semibold text-dark"><i class="bi bi-speedometer2 me-2 text-success"></i>Dashboard Overview</h4>

    <!-- Overview Cards -->
    <div class="row g-3">
      <div class="col-md-4">
        <div class="dashboard-card">
          <h6><i class="bi bi-trash3-fill me-2 text-success"></i>Total Waste Collected</h6>
          <h3 class="mt-2">2.4 tons <small class="text-muted">(Today)</small></h3>
        </div>
      </div>
      <div class="col-md-4">
        <div class="dashboard-card">
          <h6><i class="bi bi-truck-front-fill me-2 text-primary"></i>Active Trucks</h6>
          <h3 class="mt-2 text-primary">7 <small class="text-muted">Active</small></h3>
        </div>
      </div>
      <div class="col-md-4">
        <div class="dashboard-card">
          <h6><i class="bi bi-exclamation-triangle-fill me-2 text-warning"></i>Missed Collections</h6>
          <h3 class="mt-2 text-warning">2 <small class="text-muted">Delayed Routes</small></h3>
        </div>
      </div>
    </div>

    <!-- Truck Capacity Section -->
    <div class="mt-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5><i class="bi bi-truck-front-fill me-2 text-primary"></i>Truck Capacities</h5>
        <div>
          <button id="listViewBtn" class="btn btn-outline-primary btn-sm me-1 active">List View</button>
          <button id="mapViewBtn" class="btn btn-outline-primary btn-sm">Map View</button>
        </div>
      </div>

      <!-- List View -->
      <div class="row d-flex flex-wrap" id="truckCards"></div>

     <!-- Map View -->
<div id="truckMapContainer" style="height:480px; border-radius:10px; display:none;"></div>
<div class="mt-2 small text-muted">
  ðŸ”µ Blue dot = your location | ðŸš› = trucks
</div>
    </div>

    <!-- Recent Reports -->
    <div class="mt-4">
      <h5><i class="bi bi-clipboard-data-fill me-2 text-primary"></i>Recent Reports (from Residents)</h5>
      <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle mt-2">
          <thead>
            <tr>
              <th>#</th>
              <th>Barangay</th>
              <th>Issue</th>
              <th>Status</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>12</td>
              <td>Poblacion</td>
              <td>Missed collection</td>
              <td><span class="badge bg-warning text-dark">Pending</span></td>
              <td>Oct 17</td>
            </tr>
            <tr>
              <td>11</td>
              <td>Sampaloc</td>
              <td>Overflowing bin</td>
              <td><span class="badge bg-success">Resolved</span></td>
              <td>Oct 16</td>
            </tr>
            <tr>
              <td>10</td>
              <td>Guisguis</td>
              <td>Missed collection</td>
              <td><span class="badge bg-info text-dark">In-Progress</span></td>
              <td>Oct 16</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Chart -->
<div class="mt-4">
  <div class="d-flex justify-content-between align-items-center">
    <h5 class="mb-0 d-flex align-items-center">
      <i class="bi bi-bar-chart-fill me-2 text-success"></i>
      Barangay Waste Heatmap
      <i class="bi bi-info-circle text-secondary ms-2"
         data-bs-toggle="tooltip"
         data-bs-placement="top"
         title="Shows the density of waste collection reports across the barangays.">
      </i>
    </h5>


  <div class="input-group input-group-sm" style="width:220px;">
    <button class="btn btn-outline-secondary" id="prevWeek">&lt;</button>
    <input type="text" id="weekLabel" class="form-control text-center" readonly value="Jan 26 â€“ Feb 1 2026">
    <button class="btn btn-outline-secondary" id="nextWeek">&gt;</button>
  </div>
</div>



  </div>

  <div class="heatmap-container mt-3">

  <table class="heatmap-table">
    <thead>
      <tr>
        <th>Barangay</th>
        <th>M</th><th>T</th><th>W</th><th>T</th><th>F</th><th>S</th>
      </tr>
    </thead>
    <tbody id="heatmapBody"></tbody>
  </table>
<div class="d-flex justify-content-between align-items-start mt-3">
  <!-- Left side: View All + Download -->
  <div class="d-flex align-items-center">
    <!-- View All Barangays -->
    <button class="btn btn-sm btn-link text-success p-0 me-2" id="viewAllBtn">
      View all barangays
    </button>
    <!-- Download CSV -->
    <button class="btn btn-sm btn-outline-success" id="downloadHeatmapBtn">
      <i class="bi bi-download me-1"></i> Download
    </button>
  </div>

  <!-- Right side: Legend -->
  <div class="heatmap-legend">
    <span><i class="legend-box low"></i> Below Avg (&lt; 3 tons)</span>
    <span><i class="legend-box mid"></i> Target (3â€“5 tons)</span>
    <span><i class="legend-box high"></i> High (&gt; 5 tons)</span>
    <span><i class="legend-box zero"></i> No Data</span>
  </div>
</div>


<!-- Modal for all barangays -->
<div class="modal fade" id="allBarangaysModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
<div class="modal-header d-flex justify-content-between align-items-center">
  <!-- Title left -->
  <h5 class="modal-title mb-0">All Barangays - Waste Heatmap</h5>
  <!-- Right side: week navigation + close button -->
  <div class="d-flex align-items-center">
    <button class="btn btn-outline-secondary btn-sm me-1" id="modalPrevWeek">&lt;</button>
    <input
      type="text"
      id="modalWeekLabel"
      class="form-control form-control-sm text-center me-1"
      readonly
      style="width:160px;"
    >
    <button class="btn btn-outline-secondary btn-sm me-2" id="modalNextWeek">&gt;</button>
    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
  </div>
</div>

     <div class="modal-body">
  <table class="table table-bordered table-striped align-middle" id="modalHeatmapTable">
    <thead>
      <tr>
        <th>Barangay</th>
        <th>M</th><th>T</th><th>W</th><th>T</th><th>F</th><th>S</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- LEGEND SA IBABA NG TABLE, RIGHT-ALIGNED -->
  <div class="d-flex justify-content-end mt-3">
    <div class="heatmap-legend">
      <span><i class="legend-box low"></i> Below Avg (&lt; 3 tons)</span>
      <span><i class="legend-box mid"></i> Target (3â€“5 tons)</span>
      <span><i class="legend-box high"></i> High (&gt; 5 tons)</span>
      <span><i class="legend-box zero"></i> No Data</span>
    </div>
  </div>
</div>

</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<script>
/* ----------------- TRUCK DATA ----------------- */
const trucks = [
  { id:"Truck 01", collector:"Juan Dela Cruz", capacity:55,
    route:[[121.4785,13.9905],[121.4795,13.9912],[121.4810,13.9901]], barangay:"Poblacion", lastUpdated:"12:34 PM" },
  { id:"Truck 02", collector:"Maria Santos", capacity:78,
    route:[[121.4742,13.9871],[121.4728,13.9865],[121.4715,13.9882]], barangay:"Sampaloc", lastUpdated:"12:20 PM" },
  { id:"Truck 03", collector:"Pedro Reyes", capacity:92,
    route:[[121.4791,13.9852],[121.4813,13.9841],[121.4820,13.9860]], barangay:"Guisguis", lastUpdated:"11:50 AM" },
  { id:"Truck 04", collector:"Miguel De Torre", capacity:45,
    route:[[121.4795,13.9885],[121.4805,13.9880],[121.4815,13.9890]], barangay:"Sto. Cristo", lastUpdated:"12:10 PM" },
  { id:"Truck 05", collector:"Luis Garcia", capacity:88,
    route:[[121.4765,13.9920],[121.4775,13.9915],[121.4785,13.9925]], barangay:"Talaan", lastUpdated:"11:45 AM" },
  { id:"Truck 06", collector:"Sofia Reyes", capacity:60,
    route:[[121.4745,13.9840],[121.4755,13.9835],[121.4765,13.9845]], barangay:"Concepcion Banahaw", lastUpdated:"12:05 PM" },
  { id:"Truck 07", collector:"Marco Santos", capacity:72,
    route:[[121.4780,13.9865],[121.4790,13.9860],[121.4800,13.9870]], barangay:"Mamala 1", lastUpdated:"11:30 AM" }
];
/* ------------- RENDER TRUCK CARDS (LIST VIEW) ------------- */
function renderTruckCards() {
  const container = document.getElementById('truckCards');
  container.innerHTML = "";

  // Flex container to center trucks in rows
  const flexContainer = document.createElement('div');
  flexContainer.className = "d-flex flex-wrap justify-content-center mb-3";
  container.appendChild(flexContainer);

  // Render each truck
  trucks.forEach(truck => {
    let colorClass, statusText;
    if (truck.capacity <= 60) { colorClass = "bg-success-fill"; statusText = "Normal"; }
    else if (truck.capacity <= 85) { colorClass = "bg-warning-fill"; statusText = "Near Full"; }
    else { colorClass = "bg-danger-fill"; statusText = "Full"; }

    const truckCard = document.createElement('div');
    truckCard.className = "d-flex flex-column align-items-center m-2";
    truckCard.innerHTML = `
      <div class="truck-card shadow-sm" style="width:120px;">
        <h6><b>${truck.collector}</b> (${truck.id})</h6>
        <div class="garbage-bin">
          <div class="garbage-fill ${colorClass}" style="height:${truck.capacity}%">
            ${truck.capacity}%
          </div>
        </div>
        <span class="badge ${colorClass} mt-1">${statusText}</span><br>
        <small class="text-muted">Last Updated: ${truck.lastUpdated}</small>
      </div>
    `;
    flexContainer.appendChild(truckCard);
  });
}
/* ------------- TOGGLE LIST / MAP VIEW ------------- */
const listViewBtn = document.getElementById('listViewBtn');
const mapViewBtn = document.getElementById('mapViewBtn');
const truckCardsContainer = document.getElementById('truckCards');
const truckMapContainer = document.getElementById('truckMapContainer');

function showListView() {
  truckCardsContainer.style.display = 'block'; // show list
  truckMapContainer.style.display = 'none';    // hide map
  listViewBtn.classList.add('active');
  mapViewBtn.classList.remove('active');
}

/* ----------------- MAP & SMOOTH TRUCK ANIMATION ----------------- */
function showMapView() {
  truckCardsContainer.style.display = 'none';  // hide list
  truckMapContainer.style.display = 'block';   // show map
  mapViewBtn.classList.add('active');
  listViewBtn.classList.remove('active');

  if (!window.truckMap) {
    // Initialize Map
    window.truckMap = new maplibregl.Map({
      container: 'truckMapContainer',
      style: {
        version: 8,
        sources: {
          osm: {
            type: 'raster',
            tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
            tileSize: 256
          }
        },
        layers: [{ id: 'osm-layer', type: 'raster', source: 'osm' }]
      },
      center: [121.4761, 13.9897],
      zoom: 14
    });
    window.truckMap.addControl(new maplibregl.NavigationControl(), 'bottom-right');

    // Initialize trucks
    trucks.forEach(truck => {
      const el = document.createElement('div');
      el.innerHTML = "ðŸš›";
      el.style.fontSize = "24px";

      let statusText;
      if (truck.capacity <= 60) statusText = "Normal";
      else if (truck.capacity <= 85) statusText = "Near Full";
      else statusText = "Full";

      const popup = new maplibregl.Popup({ offset: 25 }).setHTML(
        `<b>${truck.id}</b><br>
         Barangay: ${truck.barangay}<br>
         Capacity: ${truck.capacity}%<br>
         Status: <span style="color:${statusText==='Normal'?'green':statusText==='Near Full'?'orange':'red'}">${statusText}</span>`
      );

      truck.marker = new maplibregl.Marker(el)
                       .setLngLat(truck.route[0])
                       .setPopup(popup)
                       .addTo(window.truckMap);

      // Animation properties
      truck.currentStep = 0;
      truck.nextStep = 1;
      truck.progress = 0;
      truck.speed = 0.005; // adjust speed: smaller = slower
    });

    // Smooth animation function
    function animateTrucks() {
      trucks.forEach(truck => {
        let start = truck.route[truck.currentStep];
        let end = truck.route[truck.nextStep];

        // Linear interpolation between points
        let lng = start[0] + (end[0]-start[0]) * truck.progress;
        let lat = start[1] + (end[1]-start[1]) * truck.progress;
        truck.marker.setLngLat([lng, lat]);

        truck.progress += truck.speed;

        if(truck.progress >= 1){
          truck.currentStep = truck.nextStep;
          truck.nextStep = (truck.nextStep + 1) % truck.route.length;
          truck.progress = 0;
        }
      });

      requestAnimationFrame(animateTrucks);
    }

    // Start the animation
    animateTrucks();
  }
}

// Event listeners
listViewBtn.addEventListener('click', showListView);
mapViewBtn.addEventListener('click', showMapView);

// Default to list view
showListView();

// Render truck cards
renderTruckCards();


/* ---------------- CHART ---------------- */
const ctx=document.getElementById('wasteChart');
new Chart(ctx,{
  type:'bar',
  data:{
    labels:['Poblacion','Sampaloc','Guisguis','Sto. Cristo','Talaan'],
    datasets:[{label:'Total Waste (tons)',data:[2.4,1.8,1.2,0.9,0.7],backgroundColor:'#1e5631'}]
  },
  options:{
    responsive:true,
    plugins:{legend:{display:false}},
    scales:{
      y:{beginAtZero:true,title:{display:true,text:'Tons Collected'}},
      x:{title:{display:true,text:'Barangay'}}
    }
  }
});
/* ---------------- HEATMAP ---------------- */
/* ---------------- HEATMAP ---------------- */

// All barangays in Sariaya Quezon
const allBarangays = [
  "Poblacion 1","Poblacion 2","Poblacion 3","Poblacion 4","Poblacion 5","Poblacion 6",
  "Antipolo","Balubal","Bignay 1","Bignay 2","Bucal","Canda","CastaÃ±as",
  "Concepcion I","Concepcion Banahaw","Concepcion Palasan","Concepcion Pinagbakuran",
  "Gibanga","Guisguis-San Roque","Guisguis-Talon","Janagdong 1","Janagdong 2",
  "Limbon","Lutucan 1","Lutucan Bata","Lutucan Malabag","Mamala I","Mamala II",
  "Manggalang 1","Manggalang Tulo-tulo","Manggalang-Bantilan","Manggalang-Kiling",
  "Montecillo","Morong","Pili","Sampaloc 1","Sampaloc 2","Sampaloc Bogon",
  "Santo Cristo","Talaan Aplaya","Talaan Pantoc","Tumbaga 1","Tumbaga 2"
];

// Generate random example data (1â€“6 tons)
function generateExampleData() {
  return Array.from({length:6}, () => +(Math.random()*5 + 1).toFixed(1));
}

const weeks = [
  {
    label: "Jan 26 â€“ Jan 31, 2026",
    data: allBarangays.map(b => ({ barangay: b, data: generateExampleData() }))
  },
  {
    label: "Feb 2 â€“ Feb 7, 2026",
    data: allBarangays.map(b => ({ barangay: b, data: generateExampleData() }))
  },
  {
    label: "Feb 9 â€“ Feb 14, 2026",
    data: allBarangays.map(b => ({ barangay: b, data: generateExampleData() }))
  }
];


let currentWeek = 0;

// Heatmap color class
function getHeatClass(value){
  if(value === 0 || value === null || value === undefined) return "hm-zero";
  if(value < 3) return "hm-low";
  if(value <= 5) return "hm-mid";
  return "hm-high";
}

// Main table (first 5 barangays alphabetically)
const body = document.getElementById("heatmapBody");
const weekLabel = document.getElementById("weekLabel");
function renderHeatmap(){
  body.innerHTML = "";
  weekLabel.value = weeks[currentWeek].label;

  const rows = weeks[currentWeek].data.slice().sort((a,b)=>a.barangay.localeCompare(b.barangay)).slice(0,5);
  rows.forEach(row => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${row.barangay}</td>` + row.data.map(v => `<td class="${getHeatClass(v)}" title="${v} tons">${v}</td>`).join("");
    body.appendChild(tr);
  });
}

// Week navigation
document.getElementById("prevWeek").onclick = () => { currentWeek = (currentWeek - 1 + weeks.length) % weeks.length; renderHeatmap(); };
document.getElementById("nextWeek").onclick = () => { currentWeek = (currentWeek + 1) % weeks.length; renderHeatmap(); };

/* ---------------- VIEW ALL BARANGAYS MODAL ----------------- */
const viewAllBtn = document.getElementById("viewAllBtn");
const modalTableBody = document.querySelector("#modalHeatmapTable tbody");
const allBarangaysModalEl = document.getElementById("allBarangaysModal");
const allBarangaysModal = new bootstrap.Modal(allBarangaysModalEl);

function renderModalHeatmap() {
  modalTableBody.innerHTML = "";

  const sortedRows = weeks[currentWeek].data
    .slice()
    .sort((a, b) => a.barangay.localeCompare(b.barangay));

  sortedRows.forEach(row => {
    const tr = document.createElement("tr");

    // Barangay name cell
    const nameTd = document.createElement("td");
    nameTd.textContent = row.barangay;
    tr.appendChild(nameTd);

    // Day cells (WITH COLOR)
    row.data.forEach(v => {
      const td = document.createElement("td");

      const value = Number(v) || 0;   // â­ VERY IMPORTANT
      td.textContent = value;
      td.classList.add(getHeatClass(value));
      td.title = `${value} tons`;

      tr.appendChild(td);
    });

    modalTableBody.appendChild(tr);
  });

  // Update week label (2026 visible)
  allBarangaysModalEl.querySelector("#modalWeekLabel").value =
    weeks[currentWeek].label;
}

// Open modal
viewAllBtn.onclick = () => { renderModalHeatmap(); allBarangaysModal.show(); };
// Modal week navigation
document.getElementById("modalPrevWeek").onclick = () => {
  currentWeek = (currentWeek - 1 + weeks.length) % weeks.length;
  renderModalHeatmap();  // important para ma-update ang table at week label
};

document.getElementById("modalNextWeek").onclick = () => {
  currentWeek = (currentWeek + 1) % weeks.length;
  renderModalHeatmap();  // important para ma-update ang table at week label
};

document.getElementById("downloadHeatmapBtn").onclick = () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("l", "mm", "a4"); // landscape para kasya ang days

  const weekLabel = weeks[currentWeek].label;

  // Title
  doc.setFontSize(14);
  doc.text("Waste Collection Heatmap", 14, 15);

  doc.setFontSize(10);
  doc.text(`Week: ${weekLabel}`, 14, 22);

  // Table headers
  const head = [[
    "Barangay",
    "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"
  ]];

  // Table body
  const body = weeks[currentWeek].data
    .slice()
    .sort((a, b) => a.barangay.localeCompare(b.barangay))
    .map(row => [
      row.barangay,
      ...row.data.map(v => v ?? 0)
    ]);

  // AutoTable
  doc.autoTable({
    head,
    body,
    startY: 28,
    styles: {
      fontSize: 9,
      halign: "center"
    },
    headStyles: {
      fillColor: [40, 167, 69] // bootstrap green
    },
    columnStyles: {
      0: { halign: "left", cellWidth: 50 } // Barangay column
    },
    theme: "grid"
  });

  // Filename
  const fileName = `Waste_Heatmap_${weekLabel.replace(/\s|â€“/g, "_")}.pdf`;

  doc.save(fileName);
};


// Initial render
renderHeatmap();

/* ---------------- LOGOUT ---------------- */
document.getElementById('logoutBtn').addEventListener('click',e=>{
  e.preventDefault();
  if(confirm("Are you sure you want to log out?")) window.location.href="index.html";
});
</script>
</body>
</html>
